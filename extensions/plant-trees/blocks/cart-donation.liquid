{% comment %}
  Tree Planting Donation App Block - Cart Page
  Version: 8.0.0
  Using Strict Boolean Metafields
{% endcomment %}

{{ 'tree-planting-donation.css' | asset_url | stylesheet_tag }}

{%- comment -%}
  Get metafield values - IMPORTANT: Boolean metafields in Liquid are already boolean
{%- endcomment -%}
{%- assign donation_enabled = app.metafields.tree_planting.donation_enabled -%}
{%- assign donation_amount = app.metafields.tree_planting.donation_amount | default: '5.00' -%}
{%- assign product_id = app.metafields.tree_planting.donation_product_id -%}
{%- assign variant_id = app.metafields.tree_planting.donation_variant_id -%}

{%- comment -%}
  Debug output (visible in theme editor only)
{%- endcomment -%}
{% if request.design_mode %}
<div style="background: #e6f7ff; padding: 10px; margin-bottom: 10px; border-radius: 5px; font-size: 12px; border: 1px solid #1890ff;">
  <strong>ðŸŒ³ Tree Planting Debug (Theme Editor):</strong><br>
  donation_enabled: {{ donation_enabled | json }}<br>
  donation_enabled type: {{ donation_enabled.type | default: 'N/A' | json }}<br>
  donation_enabled value: {{ donation_enabled.value | default: 'N/A' | json }}<br>
  donation_amount: {{ donation_amount | json }}<br>
  product_id: {{ product_id | json }}<br>
  variant_id: {{ variant_id | json }}<br>
  <strong>Block Available: {{ donation_enabled == true and product_id and variant_id | json }}</strong>
</div>
{% endif %}

{%- comment -%}
  Check if donation is enabled - Strict boolean check
  In Liquid, boolean metafields from Shopify are already boolean (true/false)
{%- endcomment -%}
{%- if donation_enabled == true and product_id and variant_id -%}
<div class="tree-planting-donation" id="tree-planting-donation-{{ section.id }}">
  <label for="donation-checkbox-{{ section.id }}">
    <input type="checkbox"
           id="donation-checkbox-{{ section.id }}"
           name="attributes[add_donation]"
           value="yes"
           data-donation-product-id="{{ product_id }}"
           data-donation-variant-id="{{ variant_id }}"
           data-donation-amount="{{ donation_amount }}">
    <div class="donation-content">
      <span class="donation-title">
        Add <span class="donation-amount">${{ donation_amount }}</span> to plant a tree
      </span>
      <span class="donation-description">
        Support reforestation with your purchase. ${{ donation_amount }} plants one tree.
      </span>
    </div>
  </label>
  <div class="error-message" id="donation-error-{{ section.id }}"></div>
</div>

<script>
  (function() {
    'use strict';
    
    const donationCheckbox = document.querySelector('#donation-checkbox-{{ section.id }}');
    if (!donationCheckbox) return;
    
    const donationContainer = document.querySelector('#tree-planting-donation-{{ section.id }}');
    const errorElement = document.querySelector('#donation-error-{{ section.id }}');
    
    // Check if donation is already in cart
    async function checkDonationInCart() {
      try {
        const response = await fetch('/cart.js');
        const cart = await response.json();
        
        const productId = donationCheckbox.dataset.donationProductId;
        const hasDonation = cart.items.some(item => 
          item.product_id == productId || 
          (item.properties && item.properties._tree_donation === 'true')
        );
        
        // Update checkbox state if donation is in cart
        if (hasDonation !== donationCheckbox.checked) {
          donationCheckbox.checked = hasDonation;
        }
      } catch (error) {
        console.error('Error checking donation in cart:', error);
      }
    }
    
    // Handle donation checkbox change
    async function handleDonationChange(isChecked) {
      try {
        donationContainer.classList.add('loading');
        errorElement.textContent = '';
        
        const productId = donationCheckbox.dataset.donationProductId;
        const variantId = donationCheckbox.dataset.donationVariantId;
        const donationAmount = donationCheckbox.dataset.donationAmount;
        
        if (isChecked) {
          // Add donation to cart
          await addDonationToCart(productId, variantId, 1, donationAmount);
        } else {
          // Remove donation from cart
          await removeDonationFromCart(productId);
        }
        
        // Update cart
        await updateCart();
      } catch (error) {
        console.error('Error handling donation:', error);
        errorElement.textContent = 'Error updating donation. Please try again.';
        donationCheckbox.checked = !isChecked; // Revert checkbox state
      } finally {
        donationContainer.classList.remove('loading');
      }
    }
    
    // Add donation product to cart
    async function addDonationToCart(productId, variantId, quantity, donationAmount) {
      const formData = {
        items: [{
          id: variantId,
          quantity: quantity,
          properties: {
            '_tree_donation': 'true',
            '_donation_amount': donationAmount,
            '_donation_product_id': productId
          }
        }]
      };
      
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });
      
      if (!response.ok) {
        throw new Error('Failed to add donation to cart');
      }
      
      return await response.json();
    }
    
    // Remove donation product from cart
    async function removeDonationFromCart(productId) {
      try {
        const cartResponse = await fetch('/cart.js');
        const cart = await cartResponse.json();
        
        const donationItem = cart.items.find(item => 
          item.product_id == productId || 
          (item.properties && item.properties._tree_donation === 'true')
        );
        
        if (donationItem) {
          const response = await fetch('/cart/change.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: donationItem.key,
              quantity: 0
            })
          });
          
          if (!response.ok) {
            throw new Error('Failed to remove donation from cart');
          }
        }
      } catch (error) {
        throw error;
      }
    }
    
    // Update cart contents
    async function updateCart() {
      try {
        if (typeof Shopify === 'object' && Shopify.updateCart) {
          Shopify.updateCart();
        } else {
          window.location.reload();
        }
      } catch (error) {
        console.error('Error updating cart:', error);
        window.location.reload();
      }
    }
    
    // Initialize
    function initDonationCheckbox() {
      donationCheckbox.addEventListener('change', function(e) {
        handleDonationChange(e.target.checked);
      });
      
      checkDonationInCart();
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDonationCheckbox);
    } else {
      initDonationCheckbox();
    }
    
    // Listen for cart updates
    document.addEventListener('cart:updated', function() {
      setTimeout(checkDonationInCart, 500);
    });
    
  })();
</script>

{%- endif -%}

{% schema %}
{
  "name": "Tree Planting Donation",
  "target": "head",
  "available_if": "{{ app.metafields.tree_planting.donation_enabled }}",
  "settings": [
    {
      "type": "header",
      "content": "Tree Planting Donation"
    },
    {
      "type": "paragraph",
      "content": "This block adds a donation checkbox to support tree planting. Configure settings in the app."
    }
  ]
}
{% endschema %}